<link rel="stylesheet" href="/css/navbar.css">

<!-- Aplicação IMEDIATA do background salvo -->
<script>
  /* Reaplica fundo salvo imediatamente para evitar flash entre páginas */
  (function () {
    try {
      const BG_KEY = 'gestorWallpaper';
      const saved = localStorage.getItem(BG_KEY);
      if (saved) {
        const final = saved.includes('url(') ? saved : `url("${saved}")`;
        document.documentElement.style.setProperty('--bg-image', final);
      }
    } catch (e) { /* silent */ }
  })();
</script>

<nav class="navbar-gestor d-flex justify-content-between align-items-center" role="navigation"
  aria-label="Navbar Gestor">
  <!-- Brand -->
  <div class="brand-left d-flex align-items-center">
    <a href="/" class="d-flex align-items-center" aria-label="Ir para home">
      <img src="/img/Conecthar.png" alt="Conecthar" height="70" width="200">
    </a>
  </div>

  <!-- Links centrais -->
  <div class="d-flex gap-4 nav-links" role="menubar" aria-label="Links principais">
    <a href="/gestor/documentacao" class="btnNav btn" role="menuitem">Documentação</a>
    <a href="/gestor/folhadepagamento" class="btnNav btn" role="menuitem">Folha de pagamento</a>
    <a href="/gestor/beneficios" class="btnNav btn" role="menuitem">Gerenciar Benefícios</a>
    <a href="/gestor/solicitacoes" class="btnNav btn" role="menuitem">Solicitações</a>
    <a href="/gestor/gerenciamento" class="btnNav btn" role="menuitem">Gerenciar Colaboradores</a>
    <a href="/gestor/gerenciarPonto" class="btnNav btn" role="menuitem">Gerenciar ponto</a>
    <a href="/gestor/analise" class="btnNav btn" role="menuitem">Analise</a>
  </div>

  <!-- Ações (direita) -->
  <div class="d-flex align-items-center gap-3 nav-actions">
    <!-- Botão de perfil: abre popover -->
    <button id="profileToggle" class="btn-profile" type="button" aria-haspopup="true" aria-expanded="false"
      aria-controls="profile-popover" aria-label="Abrir opções de perfil" title="Perfil"
      data-username="{{usuario.nome}}" data-initialized="0">
      {{#if usuario.foto}}
      <img src="/uploads/{{usuario.foto}}" alt="Avatar de {{usuario.nome}}" class="avatar-sm">
      {{else}}
      <div class="avatar-initials" aria-hidden="true">U</div>
      {{/if}}
    </button>

    <!-- Menu extra (agora com funcionalidade de wallpaper) -->
    <button id="btnMenu" class="btn btn-link p-0" type="button" aria-label="Mais opções" title="Mais opções">
      <i class="bi bi-three-dots-vertical" aria-hidden="true">BG</i>
    </button>
  </div>
</nav>

<div class="linha" aria-hidden="true"></div>

<!-- Modal de confirmação de logout -->
<div class="modal fade" id="confirmLogoutModal" tabindex="-1" aria-labelledby="confirmLogoutTitle" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="confirmLogoutTitle">Confirmar saída</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body text-center">
        <p>Tem certeza que deseja sair da sua conta?</p>
        <div class="d-flex gap-2 justify-content-between mt-3">
          <button class="btn btn-secondary flex-fill" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-danger flex-fill" id="confirmLogoutBtn">Sair</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Perfil Modal (com upload de foto) -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-md">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="profileModalTitle">Perfil do Gestor</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <form id="profileForm" autocomplete="off" novalidate>
          <div class="d-flex align-items-center gap-3 mb-3">
            <div id="profileAvatarPreview"
              style="width:72px;height:72px;border-radius:8px;overflow:hidden;background:#f3f3f3;display:grid;place-items:center;">
              <!-- imagem ou inicial será inserida dinamicamente -->
            </div>
            <div>
              <div id="profileNomePreview" style="font-weight:700;"></div>
              <small id="profileTipoPreview" class="text-muted"></small>
              <div id="empresaNomePreview" class="small text-muted" style="margin-top:4px;"></div>
            </div>
          </div>

          <!-- Upload (arquivo) -->
          <div class="mb-2">
            <label class="form-label small">Alterar foto</label>
            <div class="d-flex gap-2 align-items-center">
              <input type="file" id="inpFotoFile" accept="image/*" style="display:none">
              <button type="button" id="btnChooseFoto" class="btn btn-outline-secondary btn-sm">Escolher
                arquivo</button>
              <span id="fotoFileName" class="small text-muted" aria-live="polite"
                style="max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></span>
            </div>
            <small class="form-text text-muted">A foto será enviada e salva na pasta /uploads.</small>
          </div>

          <div class="mb-2">
            <label class="form-label small">Empresa</label>
            <input type="text" id="inpEmpresa" class="form-control form-control-sm" disabled>
          </div>

          <div class="mb-2">
            <label class="form-label small">Nome</label>
            <input type="text" id="inpNome" class="form-control form-control-sm" required>
            <div class="invalid-feedback">Nome é obrigatório.</div>
          </div>

          <div class="mb-2">
            <label class="form-label small">Cargo</label>
            <input type="text" id="inpCargo" class="form-control form-control-sm">
          </div>

          <div class="mb-2">
            <label class="form-label small">Setor</label>
            <input type="text" id="inpSetor" class="form-control form-control-sm">
          </div>

          <div class="mb-2">
            <label class="form-label small">Tipo de jornada</label>
            <input type="text" id="inpTipoJornada" class="form-control form-control-sm" required>
            <div class="invalid-feedback">Tipo de jornada é obrigatório.</div>
          </div>

          <div class="mb-2">
            <label class="form-label small">Horas diárias</label>
            <input type="number" id="inpHorasDiarias" class="form-control form-control-sm" min="0" step="0.01" required>
            <div class="invalid-feedback">Insira horas diárias válidas.</div>
          </div>

          <div class="mt-3 d-flex gap-2 justify-content-end">
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fechar</button>
            <button type="submit" id="saveProfileBtn" class="btn btn-primary btn-sm">Salvar</button>
          </div>
        </form>
        <div id="profileFormMsg" class="mt-2" style="display:none;"></div>
      </div>
    </div>
  </div>
</div>

<!-- BG Picker Overlay (igual ao navbarCola) -->
<div id="bgPickerOverlay" class="bgpicker-overlay" aria-hidden="true" role="dialog" aria-modal="true" tabindex="-1">
  <div class="bgpicker-panel" role="document" aria-label="Escolher fundo da página">
    <header class="bgpicker-header">
      <h3>Escolher imagem de fundo</h3>
      <button id="bgPickerClose" class="btn-close" aria-label="Fechar seletor de fundo">X</button>
    </header>

    <div class="bgpicker-body">
      <p class="muted small">Clique em uma imagem para aplicar. Sua escolha será lembrada no navegador.</p>
      <div class="bg-grid" id="bgGrid" role="list"></div>
    </div>

    <footer class="bgpicker-footer">
      <button id="bgResetBtn" class="btn btn-sm btn-outline-secondary">Restaurar padrão</button>
      <button id="bgApplyBtn" class="btn btn-sm btn-primary">Fechar</button>
    </footer>
  </div>
</div>

<script>
  /* Navbar Gestor com upload de foto + troca de wallpaper e modal de perfil */
  (function () {
    document.addEventListener('DOMContentLoaded', () => {
      const BACKEND_URL = (typeof window !== 'undefined' && window.BACKEND_URL) ? window.BACKEND_URL : 'http://localhost:3001';
      const profileToggle = document.getElementById('profileToggle');
      const confirmLogoutModalEl = document.getElementById('confirmLogoutModal');
      const btnMenu = document.getElementById('btnMenu');

      if (!profileToggle) return;
      if (profileToggle.dataset.initialized === '1') return;
      profileToggle.dataset.initialized = '1';

      // Inicia iniciais
      try {
        const initialsEl = profileToggle.querySelector('.avatar-initials');
        if (initialsEl) {
          const username = profileToggle.getAttribute('data-username') || '';
          initialsEl.textContent = username.trim().charAt(0).toUpperCase() || 'U';
        }
      } catch (e) { }

      /* ---------- WALLPAPER FUNCTIONALITY ---------- */
      const BG_KEY = 'gestorWallpaper';
      const DEFAULT_BG = "url('/img/glassmorphism5.jpg')";
      const BACKGROUNDS = [
        '/img/ramon1.jpeg',
        '/img/ramon7.jpeg',
        '/img/ff2.jpg',
        '/img/ff3.jpg',
        '/img/glassmorphism2.jpg',
        '/img/glassmorphism3.jpg'
      ];

      function applyBackground(url) {
        const root = document.documentElement;
        const final = url && !url.includes('url(') ? `url('${url}')` : (url || DEFAULT_BG);
        root.style.setProperty('--bg-image', final);
        localStorage.setItem(BG_KEY, url || '');
      }

      function restoreSavedBackground() {
        const saved = localStorage.getItem(BG_KEY);
        if (saved) applyBackground(saved);
      }

      function mountBgGrid() {
        const grid = document.getElementById('bgGrid');
        if (!grid) return;
        grid.innerHTML = '';
        const saved = localStorage.getItem(BG_KEY) || '';

        BACKGROUNDS.forEach((src) => {
          const div = document.createElement('div');
          div.className = 'bg-thumb';
          div.setAttribute('role', 'listitem');
          div.tabIndex = 0;
          div.dataset.src = src;

          const img = document.createElement('img');
          img.src = src;
          img.alt = 'Fundo ' + src.split('/').pop();
          img.style.cssText = 'width: 100%; height: 92px; object-fit: cover; display:block;';

          const check = document.createElement('div');
          check.className = 'thumb-check';
          check.textContent = (saved === src) ? 'Selecionado' : 'Selecionar';

          if (saved === src) div.classList.add('selected');

          div.appendChild(img);
          div.appendChild(check);

          div.addEventListener('click', () => {
            document.querySelectorAll('.bg-thumb.selected').forEach(n => n.classList.remove('selected'));
            div.classList.add('selected');
            check.textContent = 'Selecionado';
            applyBackground(src);
          });

          div.addEventListener('keydown', (ev) => {
            if (ev.key === 'Enter' || ev.key === ' ') {
              ev.preventDefault();
              div.click();
            }
          });

          grid.appendChild(div);
        });
      }

      function openBgPicker() {
        mountBgGrid();
        const ov = document.getElementById('bgPickerOverlay');
        if (!ov) return;
        ov.setAttribute('aria-hidden', 'false');
        ov.style.display = 'flex';
        setTimeout(() => { const f = ov.querySelector('.bg-thumb'); if (f) f.focus(); }, 80);
      }

      function closeBgPicker() {
        const ov = document.getElementById('bgPickerOverlay');
        if (!ov) return;
        ov.setAttribute('aria-hidden', 'true');
        ov.style.display = 'none';
      }

      // Init picker restore & button wiring
      restoreSavedBackground();

      if (btnMenu) {
        btnMenu.addEventListener('click', openBgPicker);
      }

      document.getElementById('bgPickerClose')?.addEventListener('click', closeBgPicker);
      document.getElementById('bgApplyBtn')?.addEventListener('click', closeBgPicker);
      document.getElementById('bgResetBtn')?.addEventListener('click', () => {
        localStorage.removeItem(BG_KEY);
        document.documentElement.style.setProperty('--bg-image', DEFAULT_BG);
        document.querySelectorAll('.bg-thumb.selected').forEach(n => n.classList.remove('selected'));
        document.querySelectorAll('.bg-thumb .thumb-check').forEach(el => el.textContent = 'Selecionar');
      });

      document.addEventListener('keydown', (ev) => {
        if ((ev.key === 'Escape') && document.getElementById('bgPickerOverlay')?.getAttribute('aria-hidden') === 'false') {
          closeBgPicker();
        }
      });

      /* ---------- PROFILE POPOVER & PROFILE MODAL FUNCTIONALITY ---------- */
      let popoverInstance = null;
      let outsideClickHandler = null;
      let escHandler = null;

      function escapeHtml(str = '') {
        return String(str).replace(/[&<>"'`=\/]/g, s => {
          return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '/': '&#x2F;', '`': '&#96;', '=': '&#61;' }[s]);
        });
      }
      function buildPopoverHtml(user = {}) {
        const nome = user.nome ? escapeHtml(user.nome) : 'Usuário';
        const tipo = user.tipo_usuario ? escapeHtml(user.tipo_usuario) : '';
        const fotoUrl = getFotoUrl(user.foto);
        const empresa = user.empresa_nome ? escapeHtml(user.empresa_nome) : '';

        return `
        <div id="profile-popover" class="popover-profile" style="min-width:240px;">
          <div class="d-flex" style="gap:.6rem;padding:10px 12px;align-items:center;">
            <div style="width:44px;height:44px;border-radius:8px;overflow:hidden;flex:0 0 44px;display:grid;place-items:center;background:rgba(255,255,255,0.02);font-weight:700;color:inherit;">
              ${user.foto ? `<img src="${fotoUrl}" style="width:100%;height:100%;object-fit:cover;" alt="Avatar">` : escapeHtml(nome.charAt(0))}
            </div>
            <div style="flex:1;">
              <div style="font-weight:700;font-size:.95rem;">${nome}</div>
              <div style="font-size:.78rem;color:rgba(255,255,255,0.72)">${empresa || tipo}</div>
            </div>
          </div>

          <div style="padding:8px 10px;display:flex;flex-direction:column;gap:8px;">
            <button id="popoverViewProfile" class="btn btn-sm btn-outline-secondary btn-popover-action" type="button" style="text-align:left;">Ver perfil</button>
            <button id="popoverBgBtn" class="btn btn-sm btn-outline-primary btn-popover-action" type="button" style="text-align:left;">Alterar fundo</button>
            <button id="popoverLogoutBtn" class="btn btn-sm btn-danger btn-popover-action" type="button">Sair</button>
          </div>
        </div>
      `;
      }
      function hidePopover() {
        if (!popoverInstance) return;
        try {
          if (popoverInstance && typeof popoverInstance === 'object') {
            if (popoverInstance._activeTrigger == null) {
              // cria objeto vazio para evitar Object.keys(undefined) no bootstrap
              popoverInstance._activeTrigger = {};
            }
            // opcional: garante config mínima (não obrigatório, mas preenche potencial undefined)
            if (popoverInstance._config == null) {
              popoverInstance._config = {};
            }
          }
        } catch (e) {
          // se algo estranho acontecer, seguimos adiante — essa proteção é apenas preventiva
          console.warn('hidePopover - falha ao aplicar guard rails:', e);
        }

        // Tenta esconder e descartar o popover de forma segura
        try {
          if (typeof popoverInstance.hide === 'function') {
            popoverInstance.hide();
          }
        } catch (e) {
          console.warn('hidePopover: erro ao chamar hide() (silenciado):', e);
        }

        try {
          if (typeof popoverInstance.dispose === 'function') {
            popoverInstance.dispose();
          }
        } catch (e) {
          console.warn('hidePopover: erro ao chamar dispose() (silenciado):', e);
        }

        // Remove fallback element (quando usamos fallback-popover)
        if (popoverInstance && popoverInstance._fallbackEl) {
          try { popoverInstance._fallbackEl.remove(); } catch (e) { /* silent */ }
        }

        popoverInstance = null;

        try { profileToggle.setAttribute('aria-expanded', 'false'); } catch (e) { /* silent */ }

        if (outsideClickHandler) {
          document.removeEventListener('click', outsideClickHandler);
          outsideClickHandler = null;
        }
        if (escHandler) {
          document.removeEventListener('keydown', escHandler);
          escHandler = null;
        }
      }

      // Tentamos /api/gestor/me primeiro, se falhar tentamos /api/auth/me (compatibilidade)
      async function fetchCurrentUser() {
        const token = localStorage.getItem('token');
        if (!token) { window.location.href = '/'; return null; }
        try {
          let res = await fetch(`${BACKEND_URL}/api/gestor/me`, { headers: { Authorization: `Bearer ${token}` } });
          if (!res.ok) {
            // fallback para rota antiga
            res = await fetch(`${BACKEND_URL}/api/auth/me`, { headers: { Authorization: `Bearer ${token}` } });
          }
          if (!res.ok) return null;
          const json = await res.json();
          // suporta formatos: { success:true, usuario: {...} } ou { success:true, data: {...} } ou { usuario: {...} }
          return json.usuario || json.data || json.usuario || json || null;
        } catch (err) {
          console.warn('Erro ao buscar usuário:', err);
          return null;
        }
      }
      function getFotoUrl(foto) {
  if (!foto) return '';
  // Ajuste conforme a rota real onde as imagens estão no backend
  return `/uploads/${foto}`;
}

      async function toggleProfilePopover(e) {
        if (e && e.isTrusted === false) return;
        if (popoverInstance) { hidePopover(); return; }

        const token = localStorage.getItem('token');
        if (!token) { window.location.href = '/'; return; }

        let usuario = await fetchCurrentUser();
        usuario = usuario || {}; // fallback

        const useBootstrap = window.bootstrap?.Popover;
        if (useBootstrap) {
          popoverInstance = new bootstrap.Popover(profileToggle, {
            content: buildPopoverHtml(usuario),
            html: true,
            sanitize: false,
            trigger: 'manual',
            placement: 'bottom',
            container: 'body'
          });
          popoverInstance.show();
        } else {
          const div = document.createElement('div');
          div.className = 'popover fallback-popover';
          div.setAttribute('role', 'dialog');
          div.innerHTML = buildPopoverHtml(usuario);
          document.body.appendChild(div);
          const rect = profileToggle.getBoundingClientRect();
          div.style.position = 'absolute';
          const left = Math.min(window.innerWidth - 260, Math.max(8, rect.left + window.scrollX));
          div.style.left = left + 'px';
          div.style.top = (rect.bottom + 8 + window.scrollY) + 'px';
          popoverInstance = {
            _fallbackEl: div,
            hide() { try { div.remove(); } catch (e) { } },
            dispose() { try { div.remove(); } catch (e) { } }
          };
        }

        profileToggle.setAttribute('aria-expanded', 'true');

        requestAnimationFrame(() => {
          const pop = document.querySelector('.popover') || document.querySelector('.fallback-popover');
          if (!pop) return;

          const viewBtn = pop.querySelector('#popoverViewProfile');
          const bgBtn = pop.querySelector('#popoverBgBtn');
          const logoutBtn = pop.querySelector('#popoverLogoutBtn');

          viewBtn?.addEventListener('click', async (ev) => {
            ev.preventDefault();
            hidePopover();
            openProfileModal();
          });

          bgBtn?.addEventListener('click', () => {
            hidePopover();
            openBgPicker();
          });

          logoutBtn?.addEventListener('click', () => {
            hidePopover();
            if (useBootstrap && confirmLogoutModalEl) {
              const inst = new bootstrap.Modal(confirmLogoutModalEl);
              inst.show();
            } else {
              if (confirm('Deseja sair da sua conta?')) performLogout();
            }
          });

          const firstFocusable = pop.querySelector('button, a, [tabindex]:not([tabindex="-1"])');
          if (firstFocusable) firstFocusable.focus();
        });

        outsideClickHandler = (ev) => {
          const pop = document.querySelector('.popover') || document.querySelector('.fallback-popover');
          if (!pop) return;
          if (profileToggle.contains(ev.target) || pop.contains(ev.target)) return;
          hidePopover();
        };

        escHandler = (ev) => {
          if (ev.key === 'Escape') hidePopover();
        };

        document.addEventListener('click', outsideClickHandler);
        document.addEventListener('keydown', escHandler);
      }

      async function performLogout() {
        try {
          const token = localStorage.getItem('token');
          await fetch(`${BACKEND_URL}/api/auth/logout`, {
            method: 'POST',
            headers: token ? { Authorization: `Bearer ${token}` } : {}
          });
        } catch (e) {
          console.warn('Erro no logout:', e);
        } finally {
          localStorage.removeItem('token');
          try {
            const inst = bootstrap.Modal.getInstance(confirmLogoutModalEl);
            if (inst) inst.hide();
          } catch (e) { }
          window.location.href = '/';
        }
      }

      profileToggle.addEventListener('click', toggleProfilePopover);
      profileToggle.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter' || ev.key === ' ') {
          ev.preventDefault();
          toggleProfilePopover(ev);
        }
        if (ev.key === 'Tab') hidePopover();
      });

      const confirmBtn = document.getElementById('confirmLogoutBtn');
      confirmBtn?.addEventListener('click', (ev) => {
        ev.preventDefault();
        performLogout();
      });

      // Delegation for dynamically created popover button
      document.body.addEventListener('click', (ev) => {
        const t = ev.target;
        if (!t) return;
        if (t.id === 'popoverBgBtn' || (t.closest && t.closest('#popoverBgBtn'))) {
          openBgPicker();
        }
      });

      /* ---------- PROFILE MODAL: abrir, preencher, upload e salvar ---------- */

      // elements for upload
      const inpFotoFile = document.getElementById('inpFotoFile');
      const btnChooseFoto = document.getElementById('btnChooseFoto');
      const fotoFileName = document.getElementById('fotoFileName');
      let selectedFile = null;

      btnChooseFoto?.addEventListener('click', () => {
        inpFotoFile?.click();
      });

      inpFotoFile?.addEventListener('change', (ev) => {
        const f = ev.target.files && ev.target.files[0];
        selectedFile = f || null;
        fotoFileName.textContent = selectedFile ? selectedFile.name : '';
        // preview immediately
        const avatarEl = document.getElementById('profileAvatarPreview');
        if (selectedFile && avatarEl) {
          const url = URL.createObjectURL(selectedFile);
          avatarEl.innerHTML = `<img src="${url}" alt="Preview" style="width:100%;height:100%;object-fit:cover;">`;
          // revoke later when modal closed
          setTimeout(() => URL.revokeObjectURL(url), 5000);
        }
      });

      async function uploadAvatarFile(token, file) {
        if (!file) return null;
        try {
          const fd = new FormData();
          fd.append('documento', file); // Nome do campo deve corresponder ao backend

          const res = await fetch(`${BACKEND_URL}/api/upload/usuario/upload`, {
            method: 'POST',
            headers: {
              Authorization: `Bearer ${token}`
              // NÃO adicionar Content-Type com FormData
            },
            body: fd
          });

          if (!res.ok) {
            const errorText = await res.text();
            console.error('Upload falhou:', res.status, errorText);
            throw new Error(`Upload falhou: ${errorText || res.status}`);
          }

          const json = await res.json();

          // Extrair filename da resposta (adapte conforme seu backend retorna)
          const filename = json.filename ||
            json.fileName ||
            json.file ||
            json.data?.filename ||
            json.data?.fileName ||
            json.path;

          if (!filename) {
            console.warn('Nenhum filename retornado:', json);
            throw new Error('Nome do arquivo não retornado pelo servidor');
          }

          return filename;
        } catch (err) {
          console.error('Erro no uploadAvatarFile:', err);
          throw err;
        }
      }
      async function openProfileModal() {
        const usuario = await fetchCurrentUser();
        if (!usuario) {
          alert('Não foi possível carregar os dados do usuário.');
          return;
        }

        const avatarEl = document.getElementById('profileAvatarPreview');
        const fotoUrl = getFotoUrl(usuario.foto);

        if (usuario.foto) {
          avatarEl.innerHTML = `<img src="${fotoUrl}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;">`;
        } else {
          avatarEl.textContent = (usuario.nome || 'U').charAt(0).toUpperCase();
        }


        nomePreview.textContent = usuario.nome || '';
        tipoPreview.textContent = usuario.tipo_usuario ? usuario.tipo_usuario.toLowerCase() : '';
        empresaPreview.textContent = usuario.empresa_nome ? usuario.empresa_nome : '';

        // Preenche campos do formulário (empresa desabilitada)
        document.getElementById('inpEmpresa').value = usuario.empresa_nome || usuario.empresa_id || '';
        document.getElementById('inpNome').value = usuario.nome || '';
        document.getElementById('inpCargo').value = usuario.cargo || '';
        document.getElementById('inpSetor').value = usuario.setor || '';
        document.getElementById('inpTipoJornada').value = usuario.tipo_jornada || '';
        document.getElementById('inpHorasDiarias').value = usuario.horas_diarias || '';

        // reset upload state
        selectedFile = null;
        fotoFileName.textContent = '';

        // mostra modal (Bootstrap se disponível)
        if (window.bootstrap && bootstrap.Modal) {
          const mEl = document.getElementById('profileModal');
          const inst = new bootstrap.Modal(mEl);
          inst.show();
        } else {
          // fallback simples: tornar visível com focus
          const m = document.getElementById('profileModal');
          m.style.display = 'block';
        }
      }

      async function saveProfileForm(ev) {
        ev.preventDefault();
        const form = document.getElementById('profileForm');
        // simple validation
        const nome = document.getElementById('inpNome').value.trim();
        const cargo = document.getElementById('inpCargo').value.trim();
        const setor = document.getElementById('inpSetor').value.trim();
        const tipo_jornada = document.getElementById('inpTipoJornada').value.trim();
        const horas_diarias = document.getElementById('inpHorasDiarias').value;

        form.classList.remove('was-validated');
        if (!nome || !tipo_jornada || horas_diarias === '') {
          form.classList.add('was-validated');
          return;
        }

        const token = localStorage.getItem('token');
        if (!token) { window.location.href = '/'; return; }

        const payload = { nome, cargo, setor, tipo_jornada, horas_diarias };

        const msgEl = document.getElementById('profileFormMsg');
        msgEl.style.display = 'block';
        msgEl.className = 'text-muted small';
        msgEl.textContent = 'Salvando...';

        try {
          // se houver arquivo selecionado, faz upload primeiro
          if (selectedFile) {
            msgEl.textContent = 'Enviando foto...';
            let uploadedFileName = await uploadAvatarFile(token, selectedFile);
            if (!uploadedFileName) {
              throw new Error('Resposta de upload inválida (nenhum nome de arquivo retornado).');
            }
            // adiciona ao payload para atualizar campo foto
            payload.foto = uploadedFileName;
          }

          // chama endpoint de atualização (rota: PUT /api/gestor/atualizar)
          const res = await fetch(`${BACKEND_URL}/api/gestor/atualizar`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(payload)
          });

          const json = await res.json();

          if (res.ok && json.success !== false) {
            msgEl.className = 'text-success small';
            msgEl.textContent = json.message || 'Perfil atualizado com sucesso.';

            // atualiza avatar / nome na navbar
            const toggleImg = profileToggle.querySelector('img.avatar-sm');
            // Dentro de saveProfileForm, após o upload bem-sucedido
            if (json.data && json.data.foto) {
              const fileName = json.data.foto;
              const fotoUrl = getFotoUrl(fileName);

              if (toggleImg) {
                toggleImg.src = fotoUrl;
                toggleImg.alt = json.data.nome || nome;
              } else {
                profileToggle.innerHTML = `<img src="${fotoUrl}" alt="${json.data.nome || nome}" class="avatar-sm">`;
              }
            } else {
              // Atualizar initials
              const initials = profileToggle.querySelector('.avatar-initials');
              if (initials) initials.textContent = nome.charAt(0).toUpperCase();
            }

            // Atualizar preview no modal também
            const avatarEl = document.getElementById('profileAvatarPreview');
            if (json.data && json.data.foto) {
              const fotoUrl = getFotoUrl(json.data.foto);
              avatarEl.innerHTML = `<img src="${fotoUrl}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;">`;
            } else {
              avatarEl.textContent = nome.charAt(0).toUpperCase();
            }
            // fecha modal após um pequeno delay
            setTimeout(() => {
              try { const inst = bootstrap.Modal.getInstance(document.getElementById('profileModal')); if (inst) inst.hide(); } catch (e) { }
              msgEl.style.display = 'none';
            }, 900);
          } else {
            msgEl.className = 'text-danger small';
            msgEl.textContent = json.message || 'Erro ao atualizar perfil.';
          }
        } catch (err) {
          console.error('Erro ao salvar perfil:', err);
          msgEl.style.display = 'block';
          msgEl.className = 'text-danger small';
          msgEl.textContent = (err && err.message) ? err.message : 'Erro de comunicação com o servidor.';
        }
      }

      // submit handler
      document.getElementById('profileForm')?.addEventListener('submit', saveProfileForm);

      // Close fallback modal with close buttons if no bootstrap
      document.querySelectorAll('#profileModal .btn-close, #profileModal [data-bs-dismiss="modal"]').forEach(btn => {
        btn?.addEventListener('click', (ev) => {
          const m = document.getElementById('profileModal');
          if (!window.bootstrap) m.style.display = 'none';
        });
      });

      window.addEventListener('unload', () => { hidePopover(); });
    });
  })();
</script>