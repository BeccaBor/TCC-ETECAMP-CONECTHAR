{{> navbarCola }}

<link rel="stylesheet" href="/css/dadosColaborador.css">

<div class="cola-layout">
  {{> sidebarCola }}

  <main class="content" role="main" aria-label="Meus dados">
    <header class="page-header">
      <div>
        <h2>Visualizar Dados</h2>
        <p>Visualize seus dados pessoais e contratos ativos</p>
      </div>
      <div class="header-actions">
        <div id="dadosAlertContainer" class="alert-container" aria-live="polite"></div>
      </div>
    </header>

    <!-- STATS (topo) -->
    <section class="stats-grid">
      {{!-- <div class="grid-item card stat-card">
        <div class="stat-title">Dados Pessoais</div>
        <div id="statDadosPessoais" class="stat-value">0</div>
        <div class="stat-muted">Perfil completo</div>
      </div> --}}




    </section>

    <!-- FORMULARIO PRINCIPAL -->
    <form id="formDadosColaborador" class="grid-dashboard" enctype="multipart/form-data" novalidate>
      <!-- DADOS PESSOAIS: foto à esquerda + área de 2 colunas (cada coluna com 5 elementos) -->
      <div class="grid-item card dados-pessoais-card span-3">
        <h3>Dados Pessoais</h3>

        <!-- coluna da foto (fixa) -->
        <div class="photo-col">
          <div class="photo-wrap">
            {{#if usuario.foto}}
            <img id="previewFoto" src="/uploads/{{usuario.foto}}" alt="Foto de {{usuario.nome}}">
            {{else}}
            <img id="previewFoto" src="/img/fundofoda.png" alt="Sem foto">
            {{/if}}
          </div>
          <div class="photo-meta">
            <div id="displayName">{{usuario.nome}}</div>
            <div class="muted">{{usuario.cargo}} • {{usuario.setor}}</div>
            <div class="muted">Registro: {{usuario.numero_registro}}</div>
          </div>
        </div>

        <!-- área principal com duas colunas, cada uma com 5 elementos -->
        <div class="form-area">
          <div class="form-columns">
            <!-- COLUNA A (5 elementos): Tipo Jornada -> Horas -> Nome -> Email -> Endereço/Observações -->
            <div class="col col-a">
              <div class="field-group">
                <label class="field-label">Tipo de Jornada</label>
                <input name="tipo_jornada" class="field-input" type="text" value="{{usuario.tipo_jornada}}"
                  placeholder="Ex: Integral">
              </div>

              <div class="field-group">
                <label class="field-label">Horas diárias</label>
                <input name="horas_diarias" class="field-input" type="number" min="0" value="{{usuario.horas_diarias}}"
                  placeholder="Ex: 8">
              </div>

              <div class="field-group">
                <label class="field-label">Nome Completo</label>
                <input id="inputNome" name="nome" class="field-input" type="text" value="{{usuario.nome}}"
                  placeholder="Nome completo">
              </div>




              <!-- COLUNA B (5 elementos): CPF -> Telefone -> Setor -> Cargo -> Registro -->
              <div class="col col-b">
                <div class="field-group">
                  <label class="field-label">CPF</label>
                  <input id="inputCpf" name="cpf" class="field-input" type="text"
                     value="{{usuario.cpf}}" placeholder="000.000.000-00" readonly>
                </div>


                <div class="field-group">
                  <label class="field-label">Setor</label>
                  <input id="inputSetor" name="setor" class="field-input" type="text" value="{{usuario.setor}}"
                    placeholder="Ex: Financeiro">
                </div>

                <div class="field-group">
                  <label class="field-label">Cargo</label>
                  <input id="inputCargo" name="cargo" class="field-input" type="text" value="{{usuario.cargo}}"
                    placeholder="Ex: Analista">
                </div>

                <div class="field-group">
                  <label class="field-label">Registro</label>
                  <input id="inputRegistro" name="numero_registro" class="field-input" type="text"
                    value="{{usuario.numero_registro}}" placeholder="Número de registro">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- abaixo, cartões menores (se ainda precisar) -->
        {{!-- <div class="grid-item card" data-label="Upload Foto">
          <label class="field-label">Foto (opcional)</label>
          <input id="inputFoto" class="field-input file-input" type="file" name="foto" accept="image/*">
        </div>

        <!-- AÇÕES (full width) -->
        <div class="grid-item actions-row span-3" role="group" aria-label="Ações">
          <div class="actions-inner">
            <div class="obs">Edite seus dados e clique em Salvar</div>
            <div class="actions">
              <button id="btnSalvarDados" type="submit" class="btn btn-primary">Salvar</button>
            </div>
          </div>
        </div> --}}
    </form>

    <!-- CONTRATOS (permanece como antes) -->

  </main>
</div>

<script>
  /* Script otimizado para carregar/atualizar dados do colaborador */
  (function () {
    const BACKEND_CFG = (typeof window !== 'undefined' && window.BACKEND_URL) ? String(window.BACKEND_URL) : 'http://localhost:3001';
    const API_ORIGIN = BACKEND_CFG.replace(/\/api$/, '');

    // Endpoints corretos baseados nas rotas fornecidas
    const AUTH_ME = API_ORIGIN + '/api/auth/me';
    const UPDATE_ENDPOINT = API_ORIGIN + '/api/colaborador/atualizar';

    const form = document.getElementById('formDadosColaborador');
    const alertContainer = document.getElementById('dadosAlertContainer');
    const btnSalvar = document.getElementById('btnSalvarDados');
    const previewFoto = document.getElementById('previewFoto');
    const displayName = document.getElementById('displayName');

    const statUltAtualizacao = document.getElementById('statUltAtualizacao');

    function showAlert(message, type = 'info') {
      if (!alertContainer) return;
      const el = document.createElement('div');
      el.className = 'toast-alert ' + type;
      el.textContent = message;
      alertContainer.innerHTML = '';
      alertContainer.appendChild(el);
      setTimeout(() => {
        if (alertContainer.contains(el)) alertContainer.removeChild(el);
      }, 4500);
    }

    // Busca elemento do formulário por name ou id
    function getField(nameOrId) {
      if (!form) {
        return document.querySelector(`[name="${nameOrId}"]`) || document.getElementById(nameOrId);
      }
      const byName = form.elements && form.elements[nameOrId];
      if (byName) return byName;
      return document.querySelector(`[name="${nameOrId}"]`) || document.getElementById(nameOrId);
    }

    // Define valor do campo de forma segura
    function setFieldValue(nameOrId, value) {
      const el = getField(nameOrId);
      if (!el) {
        console.warn('Campo não encontrado:', nameOrId);
        return;
      }

      try {
        if ('value' in el) {
          el.value = (value === null || typeof value === 'undefined') ? '' : String(value);
        } else if (el.length && el[0] && 'value' in el[0]) {
          el[0].value = (value === null || typeof value === 'undefined') ? '' : String(value);
        }
      } catch (e) {
        console.warn('Falha ao setar valor em', nameOrId, e);
      }
    }

    // Formata CPF para exibição
    function formatarCPF(cpf) {
      if (!cpf) return '';
      const numeros = cpf.replace(/\D/g, '');
      if (numeros.length !== 11) return cpf;
      return numeros.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    }

    // Formata telefone para exibição
    function formatarTelefone(telefone) {
      if (!telefone) return '';
      const numeros = telefone.replace(/\D/g, '');
      if (numeros.length === 11) {
        return numeros.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
      } else if (numeros.length === 10) {
        return numeros.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
      }
      return telefone;
    }

    // Preview de foto ao selecionar arquivo
    const fotoInput = getField('foto') || document.getElementById('inputFoto');
    fotoInput?.addEventListener?.('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      if (previewFoto) previewFoto.src = URL.createObjectURL(file);
    });

    // Função para obter URL correta da foto (igual ao gerenciamentoScript.js)
    function getFotoUrl(foto) {
      if (!foto) return "/img/fundofoda.png";

      // Se já tem protocolo (http/https), retorna direto
      if (foto.startsWith('http')) return foto;

      // Se começa com 'uploads/', remove o prefixo
      if (foto.startsWith('uploads/')) {
        foto = foto.replace('uploads/', '');
      }

      // Se começa com 'doc-' ou similar, é um upload real
      if (foto.includes('doc-') || foto.match(/\.(jpg|jpeg|png|gif)$/i)) {
        return `${API_ORIGIN}/uploads/${foto}`;
      }

      // Fallback para imagens padrão em /img
      return `/img/${foto}`;
    }

    async function refreshUsuarioFromApi() {
      const token = localStorage.getItem('token');
      if (!token) {
        console.warn('Token não encontrado no localStorage.');
        return;
      }

      try {
        const res = await fetch(AUTH_ME, {
          headers: { Authorization: 'Bearer ' + token },
          credentials: 'include'
        });

        if (!res.ok) {
          console.warn('Resposta não OK do auth/me:', res.status);
          if (res.status === 401) {
            localStorage.removeItem('token');
          }
          return;
        }

        const j = await res.json();

        // Normaliza resposta - pode vir em diferentes formatos
        const usuario = j.usuario || j.data || j;

        console.debug('✅ Dados recebidos do backend:', usuario);

        // Mapeamento direto dos campos do banco de dados
        setFieldValue('nome', usuario.nome || '');
        setFieldValue('inputNome', usuario.nome || '');

        // CPF - tratamento especial com formatação
        const cpfValue = usuario.cpf || '';
        setFieldValue('cpf', formatarCPF(cpfValue));
        setFieldValue('inputCpf', formatarCPF(cpfValue));

        // Telefone com formatação
        const telefoneValue = usuario.telefone || usuario.telefone_celular || '';
        setFieldValue('telefone', formatarTelefone(telefoneValue));
        setFieldValue('inputTelefone', formatarTelefone(telefoneValue));

        // Setor
        setFieldValue('setor', usuario.setor || usuario.nome_setor || '');
        setFieldValue('inputSetor', usuario.setor || usuario.nome_setor || '');

        // Cargo
        setFieldValue('cargo', usuario.cargo || '');
        setFieldValue('inputCargo', usuario.cargo || '');

        // Tipo de Jornada
        setFieldValue('tipo_jornada', usuario.tipo_jornada || usuario.jornada || '');
        setFieldValue('inputJornada', usuario.tipo_jornada || usuario.jornada || '');

        // Horas Diárias
        const horasValue = usuario.horas_diarias ?? usuario.horas ?? '';
        setFieldValue('horas_diarias', horasValue);
        setFieldValue('inputHoras', horasValue);

        // Número de Registro
        setFieldValue('numero_registro', usuario.numero_registro || usuario.registro || '');
        setFieldValue('inputRegistro', usuario.numero_registro || usuario.registro || '');

        // Atualizar preview da foto usando a mesma lógica do gerenciamentoScript.js
        if (previewFoto) {
          const fotoUrl = getFotoUrl(usuario.foto);
          previewFoto.src = fotoUrl;
          previewFoto.alt = `Foto de ${usuario.nome || 'Usuário'}`;
          previewFoto.onerror = () => {
            previewFoto.src = "/img/fundofoda.png";
          };
        }

        // Atualizar display name
        if (displayName && usuario.nome) {
          displayName.textContent = usuario.nome;
        }

      } catch (err) {
        console.error('❌ Erro ao atualizar dados do usuário:', err);
      }
    }

    // Handler do formulário de atualização
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!btnSalvar) return;

      btnSalvar.disabled = true;
      const originalText = btnSalvar.textContent;
      btnSalvar.textContent = 'Salvando...';

      const token = localStorage.getItem('token');
      if (!token) {
        showAlert('Usuário não autenticado.', 'danger');
        btnSalvar.disabled = false;
        btnSalvar.textContent = originalText || 'Salvar';
        return window.location.href = '/';
      }

      try {
        const fd = new FormData();

        // Campos a serem enviados
        const fields = [
          'nome', 'cpf', 'email', 'telefone', 'setor', 'cargo',
          'tipo_jornada', 'horas_diarias', 'observacao', 'numero_registro'
        ];

        fields.forEach(fn => {
          const el = getField(fn);
          if (!el) return;

          let val = ('value' in el) ? el.value : (el[0] && 'value' in el[0] ? el[0].value : '');

          // Remove formatação do CPF e telefone antes de enviar
          if (fn === 'cpf' && val) {
            val = val.replace(/\D/g, '');
          }
          if (fn === 'telefone' && val) {
            val = val.replace(/\D/g, '');
          }

          fd.append(fn, val ?? '');
        });

        // Arquivo de foto
        const fotoEl = getField('foto') || getField('inputFoto') || document.getElementById('inputFoto');
        if (fotoEl && fotoEl.files && fotoEl.files[0]) {
          fd.append('foto', fotoEl.files[0]);
        }

        const res = await fetch(UPDATE_ENDPOINT, {
          method: 'PUT',
          headers: { Authorization: 'Bearer ' + token },
          body: fd,
          credentials: 'include'
        });

        const texto = await res.text();
        let data;
        try {
          data = JSON.parse(texto);
        } catch (e) {
          data = { success: res.ok, message: texto };
        }

        if (res.ok) {
          showAlert('Dados atualizados com sucesso!', 'success');

          // Atualizar display name se mudou
          const novoNome = getField('nome')?.value || getField('inputNome')?.value;
          if (displayName && novoNome) {
            displayName.textContent = novoNome;
          }

          // Recarregar dados após pequeno delay
          setTimeout(() => refreshUsuarioFromApi(), 700);
        } else {
          showAlert(data.message || 'Falha ao atualizar dados.', 'danger');
          console.warn('❌ Erro na atualização:', res.status, data);
        }
      } catch (err) {
        console.error('❌ Erro ao atualizar dados:', err);
        showAlert('Erro de conexão com o servidor.', 'danger');
      } finally {
        btnSalvar.disabled = false;
        btnSalvar.textContent = originalText || 'Salvar';
      }
    });

    // Carregar dados ao iniciar
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => refreshUsuarioFromApi());
    } else {
      refreshUsuarioFromApi();
    }
  })();
</script>